name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: configure
      run: cd Oneiroi
    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-arm-none-eabi \
          g++-arm-none-eabi \
          binutils-arm-none-eabi \
          make \
          build-essential \
          gdb-multiarch
        # If the distro provides arm-none-eabi-g++ but not arm-none-eabi-c++, symlink it
        if ! command -v arm-none-eabi-c++ >/dev/null 2>&1; then
          if command -v arm-none-eabi-g++ >/dev/null 2>&1; then
            sudo ln -s "$(command -v arm-none-eabi-g++)" /usr/bin/arm-none-eabi-c++ || true
          fi
        fi
        echo "Toolchain verification:"
        which arm-none-eabi-c++
        arm-none-eabi-c++ --version
      
    - name: Build Oneiroi plugin
      run: |
        set -e
        # run make in the directory that failed previously
        make -C Oneiroi clean || true
        make -C Oneiroi -j$(nproc) CXX=arm-none-eabi-c++
      shell: bash
    
    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: oneiroi-plugins
        path: Oneiroi/plugins
     
